# ==================================================
# SERVIÇOS PSICO - USANDO BANCO EXISTENTE
# ==================================================
# Use este arquivo se você já tem o banco postgres_db_psico configurado
# ==================================================

  # ==================================================
  # PSICO - Frontend (Vite/React na porta 8082)
  # ==================================================
  psico_frontend:
    container_name: psico_frontend
    restart: always
    build:
      # SUBSTITUA pela URL do seu repositório GitHub do frontend PSICO
      context: https://GITHUB_TOKEN@github.com/AndersonSilver/TB-PSICO-FRONT.git#main
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${PSICO_VITE_API_URL:-https://api.psico.com.br/api}
        - VITE_MERCADOPAGO_PUBLIC_KEY=${PSICO_VITE_MERCADOPAGO_PUBLIC_KEY}
        - VITE_GOOGLE_CLIENT_ID=${PSICO_VITE_GOOGLE_CLIENT_ID}
    environment:
      - NODE_ENV=production
      - PORT=80
    ports:
      - "8082:80"  # Porta externa 8082 -> porta interna 80
    depends_on:
      - psico_backend
    networks:
      - webcycle_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================================================
  # PSICO - Backend/API (na porta 8083)
  # ==================================================
  psico_backend:
    container_name: psico_backend
    restart: always
    # SUBSTITUA pela URL do seu repositório GitHub do backend PSICO
    build:
      context: https://GITHUB_TOKEN@github.com/AndersonSilver/TB-PSICO-BACK.git#main
      dockerfile: Dockerfile
      target: production
    environment:
      # Database - usando o banco existente psico_postgres_db
      - DB_HOST=psico_postgres_db  # Nome do container existente
      - DB_PORT=5432                # Porta interna do container
      - DB_USERNAME=psicologia      # Usuário do banco existente
      - DB_PASSWORD=30112020699130  # Senha do banco existente
      - DB_DATABASE=psicologia-client  # Database do banco existente
      - DB_SYNCHRONIZE=${PSICO_DB_SYNCHRONIZE:-false}
      - DB_LOGGING=${PSICO_DB_LOGGING:-false}
      
      # JWT
      - JWT_SECRET=${PSICO_JWT_SECRET}
      - JWT_EXPIRES_IN=${PSICO_JWT_EXPIRES_IN:-7d}
      - JWT_REFRESH_SECRET=${PSICO_JWT_REFRESH_SECRET}
      - JWT_REFRESH_EXPIRES_IN=${PSICO_JWT_REFRESH_EXPIRES_IN:-30d}
      
      # Google OAuth
      - GOOGLE_CLIENT_ID=${PSICO_GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${PSICO_GOOGLE_CLIENT_SECRET}
      - GOOGLE_CALLBACK_URL=${PSICO_GOOGLE_CALLBACK_URL}
      
      # Payment Gateway
      - MERCADOPAGO_ACCESS_TOKEN=${PSICO_MERCADOPAGO_ACCESS_TOKEN}
      - MERCADOPAGO_PUBLIC_KEY=${PSICO_MERCADOPAGO_PUBLIC_KEY}
      - MERCADOPAGO_WEBHOOK_SECRET=${PSICO_MERCADOPAGO_WEBHOOK_SECRET}
      - MERCADOPAGO_WEBHOOK_URL=${PSICO_MERCADOPAGO_WEBHOOK_URL}
      
      # Azure Storage
      - AZURE_STORAGE_ACCOUNT_NAME=${PSICO_AZURE_STORAGE_ACCOUNT_NAME}
      - AZURE_STORAGE_ACCOUNT_KEY=${PSICO_AZURE_STORAGE_ACCOUNT_KEY}
      - AZURE_STORAGE_CONTAINER_NAME=${PSICO_AZURE_STORAGE_CONTAINER_NAME}
      - AZURE_STORAGE_CONNECTION_STRING=${PSICO_AZURE_STORAGE_CONNECTION_STRING}
      
      # Email
      - SMTP_HOST=${PSICO_SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${PSICO_SMTP_PORT:-587}
      - SMTP_USER=${PSICO_SMTP_USER}
      - SMTP_PASS=${PSICO_SMTP_PASS}
      - SMTP_FROM=${PSICO_SMTP_FROM}
      
      # App
      - PORT=3001
      - NODE_ENV=production
      - FRONTEND_URL=${PSICO_FRONTEND_URL:-https://psico.com.br}
      - CORS_ORIGIN=${PSICO_CORS_ORIGIN:-https://psico.com.br}
      - SESSION_SECRET=${PSICO_SESSION_SECRET}
    ports:
      - "8083:3001"  # Porta externa 8083 -> porta interna 3001
    volumes:
      - psico_backend_uploads:/app/temp-uploads
    depends_on:
      - postgres_db_psico  # Depende do serviço existente
    networks:
      - webcycle_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ==================================================
# ADICIONAR ESTE VOLUME NA SEÇÃO volumes:
# ==================================================
# psico_backend_uploads:

# NOTA: NÃO precisa adicionar psico_postgres_data pois já existe psico_data_new

